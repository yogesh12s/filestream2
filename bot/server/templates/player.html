<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Buffered MP4/MKV Player</title>

  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>

  <style>
    html, body { margin:0; height:100%; background:#000; }
    #stream-media { width:100%; height:100%; }
    #error-message { color:red; text-align:center; margin-top:20px; }
  </style>
</head>
<body>
  <video id="stream-media" controls></video>
  <div id="error-message"></div>

  <script>
    const mediaLink = "{{ mediaLink }}"; // backend injects URL
    const videoEl = document.getElementById("stream-media");

    // Init Plyr
    const player = new Plyr(videoEl, {
      controls: ['play-large','rewind','play','fast-forward','progress','current-time','mute','settings','fullscreen'],
      settings: ['speed','loop'],
    });

    if (!mediaLink) {
      document.getElementById("error-message").textContent = "Error: Media URL not provided";
    } else {
      if ("MediaSource" in window) {
        const mediaSource = new MediaSource();
        videoEl.src = URL.createObjectURL(mediaSource);

        mediaSource.addEventListener("sourceopen", () => {
          fetch(mediaLink)
            .then(res => {
              if (!res.body) throw new Error("ReadableStream not supported");
              return res.body.getReader();
            })
            .then(reader => {
              // You may need to set correct MIME depending on your file (MP4 example below)
              const mime = 'video/mp4; codecs="avc1.64001E, mp4a.40.2"';
              const sourceBuffer = mediaSource.addSourceBuffer(mime);

              function read() {
                reader.read().then(({done, value}) => {
                  if (done) {
                    mediaSource.endOfStream();
                    return;
                  }
                  sourceBuffer.appendBuffer(value);
                  read();
                });
              }
              read();
            })
            .catch(err => {
              document.getElementById("error-message").textContent = "Streaming error: " + err;
            });
        });
      } else {
        // Fallback: normal playback
        videoEl.src = mediaLink;
      }
    }
  </script>
</body>
</html>
